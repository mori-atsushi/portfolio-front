---
title: 'Kotlin Coroutinesで共有リソースを扱う'
description: 'Kotlin CoroutinesをUIスレッド(Dispatchers.Main)のみで使っている場合、単一のリソースを複数Coroutinesで扱った場合でも問題が発生することはほとんどありません。\n一方で、バックグラウンドスレッドを含めた複数スレッド(Dispatchers.Default, Dispathcers.IO)で単一のリソースを共有した場合は、競合が発生し予期せぬ不具合を引き起こす可能性があります。\n今回はその危険性と解決方法について紹介します。'
pubDate: '2021-11-07T06:00:00.000Z'
ogpImage: '../../assets/2021-11-07-ogp.png'
---

Kotlin CoroutinesをUIスレッド( [Dispatchers.Main](https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/-dispatchers/-main.html) )のみで使っている場合、単一のリソースを複数Coroutinesで扱った場合でも問題が発生することはほとんどありません。

一方で、バックグラウンドスレッドを含めた複数スレッド( [Dispatchers.Default](https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/-dispatchers/-default.html), [Dispathcers.IO](https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/-dispatchers/-i-o.html) ) で単一のリソースを共有した場合は、競合が発生し予期せぬ不具合を引き起こす可能性があります。

今回はその危険性と解決方法について紹介します。

## 競合が起きるとき
例えば以下のように10回インクリメントするコードを考えます。

```kotlin
var i = 0
runBlocking {
    repeat(10) {
        launch(Dispatchers.Default) {
            i += 1
        }
    }
}
println(i)
```

インクリメントを行う処理は `Dispatchers.Default` で `launch` することでマルチスレッドで行います。

これを実行すると、大抵の場合以下のように出力されるでしょう。

```text
10
```

正しく動いているように思います。

では次に、10万までインクリメントしてみます。

```diff
var i = 0
runBlocking {
-     repeat(10) {
+     repeat(100_000) {
        launch(Dispatchers.Default) {
            i += 1
        }
    }
}
println(i)
```

結果は環境によって異なると思いますが、10万より少ないケースが多いでしょう。

```text
99622
```

なぜ、インクリメントが漏れているのでしょうか？

それは、複数のスレッドが同時に値を取得、更新しようとして失敗しているためです。

1. スレッド1が変数 `i` から値 `n` を取得する
2. スレッド2が変数 `i` から値 `n` を取得する
3. スレッド1が変数 `i` を `n + 1` に更新する
4. スレッド2が変数 `i` を `n + 1` に更新する

上記は2つのスレッドで合計2回処理が行われてるのにも関わらず、1しかインクリメントされません。

## Mutexを使って解決する
上記の１つ目の解決策は、[Mutex](https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines.sync/-mutex/index.html) を使うものです。

これは [withLock](https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines.sync/with-lock.html) で囲ったブロックが同時に1つしか処理されないことを保証してくれます。

同時に実行されそうになった場合、後に実行を開始したほうを先に実行が開始されたものが終わるまで待機させてくれます。

```diff
var i = 0
+ val mutex = Mutex()
runBlocking {
    repeat(100_000) {
        launch(Dispatchers.Default) {
+             mutex.withLock {
                i += 1
+             }
        }
    }
}
println(i)
```

このように正確な結果が得られるようになりました。

```text
100000
```

## StateFlowを使う
[StateFlow](https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines.flow/-state-flow/index.html) には [update](https://kotlin.github.io/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines.flow/update.html) というスレッド安全なメソッドが生えており、以下のように利用することが出来ます。

```diff
- var i = 0
+ val i = MutableStateFlow(0)
runBlocking {
     repeat(100_000) {
        launch(Dispatchers.Default) {
-            i += 1
+            i.update { it + 1 }
        }
    }
}
- println(i)
+ println(i.value)
```

競合が発生した場合、`update` は再試行することでスレッド安全を実現しているため、`update` 内に副作用を持たせてはいけません。

## マルチスレッドは使わない
当然ですが、マルチスレッドを使わなければ競合は発生しません。

UIスレッドは１つしか無いため、`Dispatchers.Main` のみを使っていれば基本的にこのような問題は起きません。

```diff
var i = 0
runBlocking {
     repeat(10) {
     repeat(100_000) {
-         launch(Dispatchers.Default) {
+         launch(Dispatchers.Main) {
            i += 1
        }
    }
}
println(i)
```

値を取得してから書き換えるまでに `delay` 等のsuspend functionを挟むと当然競合が発生するので注意してください。

```kotlin
var i = 0
runBlocking {
     repeat(10) {
     repeat(100_000) {
        launch(Dispatchers.Main) {
            val current = i
            delay(100)
            i = current + 1
        }
    }
}
println(i)
```

また、バックグラウンドスレッドを使う場合でも、リソースを単一のスレッド内のみで扱えば問題は起こりません。

```kotlin
runBlocking {
    launch(Dispatchers.Default) {
        var i = 0
        repeat(100_000) {
            i += 1
        }
        println(i)
    }
}
```

マルチスレッドで共通リソースを扱うのは難しく、どうしても考慮漏れが発生することが多々あります。

また、間違った書き方をしていても正しく動くことも多く、その間違いを認識しづらいのも問題の１つでしょう。

共有のリソースを複数スレッドから扱うのは最低限、もしくは全く行わないようにするべきだと考えています。

---

Kotlin Coroutinesの解説本をZennにて販売しています。より詳しく学びたい方は、こちらも合わせて確認してみて下さい。

[![](../../assets/zenn-coroutines-pr.png)](https://zenn.dev/at_sushi_at/books/edf63219adfc31)
[詳解 Kotlin Coroutines \[2021\] | Zenn](https://zenn.dev/at_sushi_at/books/edf63219adfc31)